\documentclass[a4paper]{article}

\usepackage[portuguese]{babel}
\usepackage{comment}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{hyperref}
\usepackage{graphicx}
\usepackage{float}
\usepackage{multirow}
\usepackage[hypcap]{caption} % makes \ref point to top of figures and tables
\usepackage{amsmath}
\usepackage{multicol} %for page layout on section Maximização do Throughput
%\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage{pdflscape}	% landscape pages
\usepackage{subcaption}

\begin{document}

\input{./rosto.tex}

\tableofcontents
\pagebreak

\section{Introdução}
O presente trabalho tem por objectivo o desenho e implementação de um processador dedicado para processamento morfológico de imagens binárias i.e.\ imagens cujos pixeis podem ter apenas dois valores distintos.

As operações a realizar sobre as imagens são cinco: erosão, dilatação, fecho (dilatação seguida de erosão), abertura (erosão seguida de dilatação) e extração de contornos (diferença entre a imagem original e a sua erosão).

O elemento estruturante considerado é um quadrado de $3\times3$ pixeis---por exemplo na operação de erosão analisa-se uma área $3\times3$ px centrada nesse pixel para decidir se o mesmo deve ser erodido.

As imagens consideradas têm no máximo $128\times128$ px. Uma imagem é transferida de um computador para a uma BRAM da FPGA via USB e o processador dedicado deve ler dessa BRAM de entrada e escrever a imagem transformada numa BRAM de saída. A imagem transformada é depois transferida de volta PC, onde pode ser visualizada.

O desempenho do circuito é avaliado pelo tempo de processamento dos dados entre as duas memórias.

\section{Formato das Imagens}
O formato das imagens não é definido no enunciado do projecto. É esperado que os alunos desenvolvam um formato de imagem que julguem mais adequado.

As imagens têm no máximo $128\times128\times1$ bits (2 kB), que é precisamente a dimensão de cada uma das 4 BRAMs existentes na FPGA XC3S-100E-4CP132. Como tal no caso das imagens maiores a BRAM de entrada é completamente preenchida, o que significa que não sobram bits para representar por exemplo as dimensões da imagem. Assim, essa informação não pode fazer parte do formato da imagem.

Decidiu-se então que as dimensões da imagem (largura e altura) são passadas ao processador dedicado fazendo uso dos 8 interruptores existentes na placa de desenvolvimento. Introduz-se primeiro a largura e pressiona-se um botão de pressão para armazenar essa dimensão. De seguida faz-se o mesmo para a altura.

A imagem é representada em memória sempre como 4 palavras de 32 bits por cada linha da imagem. Se a imagem tiver menos que 128 bits de largura é introduzido \textit{padding} que perfaça 128 bits. O \textit{padding} utilizado consiste na extensão do último bit válido de cada linha da imagem. Estas características foram escolhida de forma a facilitar o processamento da imagem.

\section{Arquitectura}
% intro à arquitectura
As operações elementares (dilatação e erosão) podem ser realizadas em dois passos distintos: primeiro executa-se a operação apenas na horizontal, i.e. usando um elemento estruturante de dimensão $3\times1$; de seguida expande-se o resultado para a linha acima e para abaixo.

A arquitectura projectada faz uso desta propriedade e como tal tem duas datapaths pricipais. A primeira, que realiza alterações apenas na horizontal, é designada por \textit{Horizontal Alteration after Line Fetch} (HALF). A segunda faz a expansão vertical e chama-se \textit{Storing Alterations after Vertical Exchange} (SAVE). Cada uma destas datapahts tem uma FSM respectiva. A \autoref{fig:poc} ilustra as duas fases de processamento.

\begin{figure}[h]
	\centering
	\begin{subfigure}[b]{0.32\textwidth}
		\centering
		\includegraphics[width=\linewidth]{poc_orig}
		\caption{}
		\label{fig:por_orig}
	\end{subfigure}
	\begin{subfigure}[b]{0.32\textwidth}
		\centering
		\includegraphics[width=\linewidth]{poc_HALF}
		\caption{}
		\label{fig:poc_HALF}
	\end{subfigure}
	\begin{subfigure}[b]{0.32\textwidth}
		\centering
		\includegraphics[width=\linewidth]{poc_SAVE}
		\caption{}
		\label{fig:poc_SAVE}
	\end{subfigure}
	\caption{imagem (a) original (b) após HALF (c) após HALF e SAVE}
	\label{fig:poc}
\end{figure}

Para além dessas duas componentes principais do circuito existe ainda outra que é responsável por fazer o \textit{padding} de cada linha antes do armazenamento na BRAM de saída.

\subsection{HALF}
% intro ao HALF
HALF é responsável por fazer as transformações horizontais de cada linha da imagem, como exemplificado na \autoref{fig:poc_HALF}.

\subsubsection{Datapath}
A datapath da HALF tem por base dois módulos: um bloco de dilatação (D) e outro de erosão (E). Uma dilatação horizontal corresponde basicamente a fazer um OR de cada bit com o bit à sua esquerda e à sua direita; da mesma forma uma erosão corresponde a um AND. Assim, os blocos D e E são \textit{arrays} dessas portas de forma a processar palavras 32 bits de cada vez. Existe, naturalmente, alguma lógica extra que é responsável por expansões de uma palavra para outra---por exemplo se uma imagem tiver como largura duas palavras de 32 bits a dilatação horizontal da primeira pode afectar o primeiro bit da segunda; e o primeiro bit da segunda pode afectar o último bit da primeira.

O circuito dos blocos D e E pode ver-se na \autoref{fig:SAVE_E_D_blocks}.

\begin{figure}[h]
	\centering
	\begin{subfigure}[b]{0.45\textwidth}
		\centering
		\includegraphics[width=\linewidth]{SAVE_D_block}
		\caption{}
		\label{fig:SAVE_D_block}
	\end{subfigure}
	\begin{subfigure}[b]{0.45\textwidth}
		\centering
		\includegraphics[width=\linewidth]{SAVE_E_block}
		\caption{}
		\label{fig:SAVE_E_block}
	\end{subfigure}
	\caption{(a) bloco de dilatação (b) bloco de erosão}
	\label{fig:SAVE_E_D_blocks}
\end{figure}

\subsubsection{FSM}

\subsection{SAVE}
% intro ao SAVE

O módulo SAVE recebe a imagem já processada horizontalmente, e procede à sua ``expansão'' na vertical. Para isto precisa de três palavras (correspondentes às linhas actual, anterior e seguinte).

\subsubsection{Datapath}

% Falta aqui a unidade de armazenamento

Uma vez disponíveis as três palavras relevantes (ou duas, no caso da primeira e última palavra, que não têm antecessor nem sucessor, respectivamente), são sobre si efectuadas as operações lógicas correspondentes à operação morfológica a realizar sobre a imagem (ver \autoref{fig:SAVE_datapath_E_D}).

\begin{figure}[h]
	\centering
	\begin{subfigure}[b]{0.45\textwidth}
		\centering
		\includegraphics[width=\linewidth]{SAVE_datapath_D}
		\caption{Dilatação}
		\label{fig:SAVE_datapath_D}
	\end{subfigure}
	\begin{subfigure}[b]{0.45\textwidth}
		\centering
		\includegraphics[width=\linewidth]{SAVE_datapath_E}
		\caption{Erosão}
		\label{fig:SAVE_datapath_E}
	\end{subfigure}
	\caption{Unidades funcionais da Datapath do SAVE}
	\label{fig:SAVE_datapath_E_D}
\end{figure}

Estes blocos são dispostos na arquitectura especificada na \autoref{fig:SAVE_Datapath}, de maneira a realizar as várias operações.

Caso a operação seja simples, o resultado do módulo HALF é direccionado para a unidade de armazenamento principal, e a sua saída para os blocos lógicos, cujo resultado vai para a saída.

No caso de ser uma operação composta (abertura ou fecho), a saída da primeira operação é redireccionada para uma segunda unidade de armazenamento, a partir da qual é realizada a última operação antes do armazenamento na memória.

Finalmente, caso a operação seja detecção de limites, a imagem erodida horizontalmente é direccionada para a unidade de armazenamento principal, e posteriormente erodida verticalmente. Simultaneamente, a imagem original, inalterada, é direccionada para a segunda unidade de armazenamento, cuja saída é direccionada para o bloco de Subtracção, cuja única operação é uma \texttt{XOR} bit-a-bit entre os dois operandos.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.6\linewidth]{SAVE_Datapath}
	\caption{Datapath do módulo SAVE}
	\label{fig:SAVE_Datapath}
\end{figure}

\subsubsection{FSM}

\subsection{\textit{Padder}}
% intro ao padder

\subsubsection{Datapath}

\subsubsection{FSM}

\subsection{Interligação dos Componentes}	% titulo melhor ?

\section{\textit{Performance}}	% titulo melhor ?

\section{Conclusões e Comentários}

\end{document}